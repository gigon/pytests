<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Data - Shufersal Coupon Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="bi bi-receipt"></i> Shufersal Coupon Manager
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="bi bi-arrow-left"></i> Back to Coupons
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2><i class="bi bi-upload"></i> Import Coupon Data</h2>
                <p class="text-muted">Import coupon data from CSV files or the existing data directory.</p>

                <!-- Import from Data Directory -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-folder"></i> Import from Data Directory</h5>
                    </div>
                    <div class="card-body">
                        <p>Import all CSV files from the <code>data/</code> directory automatically.</p>
                        <button class="btn btn-primary" onclick="importDataDirectory()">
                            <i class="bi bi-download"></i> Import from Data Directory
                        </button>
                        <div id="data-directory-result" class="mt-3"></div>
                    </div>
                </div>

                <!-- Import CSV File -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-file-earmark-text"></i> Import CSV File</h5>
                    </div>
                    <div class="card-body">
                        <p>Upload a CSV file with coupon data. Expected columns: <code>title</code>, <code>subtitle</code>, <code>dateValid</code>, <code>restrictions</code></p>
                        <form id="csv-upload-form" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="csv-file" accept=".csv" required>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-upload"></i> Upload CSV
                            </button>
                        </form>
                        <div id="csv-upload-result" class="mt-3"></div>
                    </div>
                </div>

                <!-- Exclusion Keywords Management -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-tags"></i> Manage Exclusion Keywords</h5>
                    </div>
                    <div class="card-body">
                        <p>Manage keywords for automatic exclusion or emphasis of coupons.</p>
                        
                        <!-- Add New Keyword -->
                        <form id="keyword-form" class="mb-3">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="keyword-input" 
                                           placeholder="Enter keyword..." required>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="keyword-type">
                                        <option value="exclude">Exclude</option>
                                        <option value="emphasize">Emphasize</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Existing Keywords -->
                        <div id="keywords-list">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Import from data directory
        function importDataDirectory() {
            const button = event.target;
            const resultDiv = document.getElementById('data-directory-result');
            
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';
            
            fetch('/api/import/data-directory')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> 
                                Successfully imported ${data.total_imported} coupons from ${data.imported_files.length} files.
                                ${data.imported_files.length > 0 ? 
                                    '<ul>' + data.imported_files.map(f => `<li>${f.filename}: ${f.count} coupons</li>`).join('') + '</ul>' 
                                    : ''}
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> Error: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error importing data: ${error.message}
                        </div>
                    `;
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-download"></i> Import from Data Directory';
                });
        }

        // CSV file upload
        document.getElementById('csv-upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('csv-file');
            const resultDiv = document.getElementById('csv-upload-result');
            const submitButton = this.querySelector('button[type="submit"]');
            
            if (!fileInput.files[0]) {
                alert('Please select a CSV file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading...';
            
            fetch('/api/import/csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> 
                            Successfully imported ${data.imported_count} coupons.
                        </div>
                    `;
                    fileInput.value = '';
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error: ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error uploading file: ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="bi bi-upload"></i> Upload CSV';
            });
        });

        // Keywords management
        function loadKeywords() {
            fetch('/api/exclusions')
                .then(response => response.json())
                .then(keywords => {
                    const listDiv = document.getElementById('keywords-list');
                    if (keywords.length === 0) {
                        listDiv.innerHTML = '<p class="text-muted">No keywords defined yet.</p>';
                        return;
                    }
                    
                    const excludeKeywords = keywords.filter(k => k.exclusion_type === 'exclude');
                    const emphasizeKeywords = keywords.filter(k => k.exclusion_type === 'emphasize');
                    
                    let html = '';
                    
                    if (excludeKeywords.length > 0) {
                        html += '<h6>Exclusion Keywords</h6>';
                        html += '<div class="mb-3">';
                        excludeKeywords.forEach(keyword => {
                            html += `
                                <span class="badge bg-danger me-1 mb-1">
                                    ${keyword.keyword}
                                    <button type="button" class="btn-close btn-close-white ms-1" 
                                            onclick="deleteKeyword(${keyword.id})"></button>
                                </span>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    if (emphasizeKeywords.length > 0) {
                        html += '<h6>Emphasis Keywords</h6>';
                        html += '<div class="mb-3">';
                        emphasizeKeywords.forEach(keyword => {
                            html += `
                                <span class="badge bg-success me-1 mb-1">
                                    ${keyword.keyword}
                                    <button type="button" class="btn-close btn-close-white ms-1" 
                                            onclick="deleteKeyword(${keyword.id})"></button>
                                </span>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    listDiv.innerHTML = html;
                });
        }

        // Add keyword
        document.getElementById('keyword-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const keyword = document.getElementById('keyword-input').value.trim();
            const type = document.getElementById('keyword-type').value;
            
            if (!keyword) return;
            
            fetch('/api/exclusions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ keyword: keyword, type: type })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('keyword-input').value = '';
                    loadKeywords();
                } else {
                    alert('Error adding keyword: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error adding keyword: ' + error.message);
            });
        });

        // Delete keyword
        function deleteKeyword(keywordId) {
            if (!confirm('Are you sure you want to delete this keyword?')) return;
            
            fetch(`/api/exclusions/${keywordId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadKeywords();
                } else {
                    alert('Error deleting keyword');
                }
            })
            .catch(error => {
                alert('Error deleting keyword: ' + error.message);
            });
        }

        // Load keywords on page load
        loadKeywords();
    </script>
</body>
</html>